<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çŸ¥è¯†ç£¨åŠ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --bg: #000; --card: #1c1c1e; --accent: #0A84FF; --text: #fff; --sub: #8e8e93; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #inbox { width: 300px; background: #121212; border-right: 1px solid #333; padding: 25px; display: flex; flex-direction: column; }
        #workspace { flex: 1; padding: 40px; overflow-y: auto; }
        textarea { width: 100%; height: 120px; border-radius: 12px; border: 1px solid #333; background: #2c2c2e; color: #fff; padding: 12px; margin-bottom: 15px; resize: none; }
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        
        .bank-item { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        .tag { display: inline-block; background: rgba(10, 132, 255, 0.2); color: var(--accent); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 5px; }
        
        /* å¼¹çª—æ ·å¼ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-card { width: 600px; max-height: 85vh; background: #2c2c2e; border-radius: 20px; padding: 30px; overflow-y: auto; }

        /* å“åº”å¼æ‰‹æœºå¸ƒå±€ */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            #inbox { width: 100%; border-right: none; border-bottom: 1px solid #333; }
        }
    </style>
</head>
<body>

    <div id="inbox">
        <h2 style="font-size: 20px;">ğŸ“¥ æ•è·</h2>
        <textarea id="rawInput" placeholder="åœ¨æ­¤ç²˜è´´é•¿æ–‡æœ¬æˆ–ç½‘é¡µé“¾æ¥..."></textarea>
        <button onclick="startMetabolism()">å¼€å§‹ä»£è°¢</button>

        <div style="margin-top: auto; border-top: 1px solid #333; padding-top: 20px;">
            <div style="font-size: 11px; color: var(--sub); margin-bottom: 8px;">CONFIG</div>
            <button onclick="updateKey()" style="background: #333; width: 100%; font-size: 12px; margin-bottom: 10px;">é…ç½® API Key</button>
            <button onclick="clearAllData()" style="background: #ff453a; width: 100%; font-size: 12px; opacity: 0.6;">æ¸…ç©ºä¿é™©ç®±</button>
        </div>
    </div>

    <div id="workspace">
        <h2 id="vault-title">ğŸ§  çŸ¥è¯†ä¿é™©ç®±</h2>
        <div id="knowledge-bank"></div>
    </div>

    <div id="mill-modal" class="modal">
        <div class="modal-card">
            <h3 id="ai-title">æ­£åœ¨å‡†å¤‡...</h3>
            <p id="ai-summary" style="color:#bbb;"></p>
            <div id="recall-area" style="display:none;">
                <p id="ai-question" style="color:var(--accent); font-weight:bold;"></p>
                <input type="text" id="answerInput" placeholder="å†™ä¸‹ä½ çš„ç¬¬ä¸€ååº”..." style="width:100%; padding:12px; background:#1c1c1e; border:1px solid #444; color:white; border-radius:8px;">
                <button onclick="finishRecall()" style="width:100%; margin-top:15px;">å­˜å…¥ä¿é™©ç®±</button>
            </div>
        </div>
    </div>

    <script>
        // --- è·å–æœ¬åœ°å­˜å‚¨çš„ Key ---
        let GEMINI_API_KEY = localStorage.getItem('MY_MILL_KEY') || '';

        function getApiUrl() {
            return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        }

        function updateKey() {
            const newKey = prompt("è¯·è¾“å…¥æ‚¨çš„ Gemini API Key:", GEMINI_API_KEY);
            if (newKey) {
                GEMINI_API_KEY = newKey.trim();
                localStorage.setItem('MY_MILL_KEY', GEMINI_API_KEY);
                alert("Key å·²ä¿å­˜è‡³æœ¬åœ°");
            }
        }

        window.onload = () => {
            const savedData = localStorage.getItem('my_knowledge_vault');
            if (savedData) JSON.parse(savedData).forEach(item => renderItem(item));
            if (!GEMINI_API_KEY) setTimeout(() => alert("è¯·å…ˆç‚¹å‡»ä¸‹æ–¹çš„ã€é…ç½® API Keyã€"), 1000);
        };

        // --- æ ¸å¿ƒä»£è°¢é€»è¾‘ ---
        async function startMetabolism() {
            if (!GEMINI_API_KEY) {
                alert("è¯·å…ˆè®¾ç½® API Key");
                updateKey();
                return;
            }

            let input = document.getElementById('rawInput').value.trim();
            if (!input) return;

            // å¼€å¯å¼¹çª—
            document.getElementById('mill-modal').style.display = 'flex';
            document.getElementById('ai-title').innerText = "ğŸ§  æ­£åœ¨æ¶ˆåŒ–...";
            document.getElementById('recall-area').style.display = 'none';

            // ç½‘é¡µæŠ“å–é€»è¾‘
            if (input.startsWith('http')) {
                document.getElementById('ai-title').innerText = "ğŸ”— æ­£åœ¨æŠ“å–ç½‘é¡µ...";
                try {
                    const res = await fetch(`https://r.jina.ai/${input}`);
                    if (res.ok) input = await res.text();
                } catch (e) { console.log("æŠ“å–å—é™"); }
            }

            const promptText = `è¯·å°†ä»¥ä¸‹å†…å®¹è½¬ä¸ºJSON:{"summary":"ä¸€å¥è¯æ¦‚æ‹¬","question":"ä¸€ä¸ªè¿½é—®","full_note":"ç¬”è®°","tags":["æ ‡ç­¾"]} å†…å®¹:${input.substring(0,10000)}`;

            try {
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });

                const data = await response.json();
                const aiResult = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));

                document.getElementById('ai-title').innerText = "âœ… ä»£è°¢å®Œæˆ";
                document.getElementById('ai-summary').innerText = aiResult.summary;
                document.getElementById('ai-question').innerText = "ğŸ¤” æ€è€ƒï¼š" + aiResult.question;
                document.getElementById('recall-area').style.display = 'block';
                window.currentData = aiResult;

            } catch (e) {
                alert("ä»£è°¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Keyã€‚é”™è¯¯ä¿¡æ¯ï¼š" + e.message);
                document.getElementById('mill-modal').style.display = 'none';
            }
        }

        // --- å­˜å‚¨ä¸æ¸²æŸ“é€»è¾‘ (ç®€ç•¥ç‰ˆï¼Œä¿æŒåŸæœ‰é€»è¾‘) ---
        function finishRecall() {
            const newItem = {
                id: Date.now(),
                time: new Date().toLocaleString(),
                summary: window.currentData.summary,
                full_note: window.currentData.full_note,
                tags: window.currentData.tags,
                myAnswer: document.getElementById('answerInput').value
            };
            const savedData = JSON.parse(localStorage.getItem('my_knowledge_vault') || '[]');
            savedData.unshift(newItem);
            localStorage.setItem('my_knowledge_vault', JSON.stringify(savedData));
            renderItem(newItem, true);
            document.getElementById('mill-modal').style.display = 'none';
        }

        function renderItem(item, isNew = false) {
            const div = document.createElement('div');
            div.className = 'bank-item';
            div.innerHTML = `<small>${item.time}</small><div>${item.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div><p><b>${item.summary}</b></p>`;
            const bank = document.getElementById('knowledge-bank');
            if (isNew) bank.prepend(div); else bank.appendChild(div);
        }

        function clearAllData() { if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) { localStorage.removeItem('my_knowledge_vault'); location.reload(); } }
    </script>
</body>
</html>
